services:
  scylladb:
    image: scylladb/scylla:latest
    container_name: dreamhost-scylladb
    ports:
      - "9042:9042"  # CQL native protocol (primary for Node.js cassandra-driver)
      - "8000:8000"  # Alternator API (DynamoDB-compatible)
      - "10000:10000" # REST API
    environment:
      - SCYLLA_ALTERNATOR_PORT=8000
      - SCYLLA_ALTERNATOR_WRITE_ISOLATION=forbid_rmw
    command: --smp 1 --memory 1024M --overprovisioned 1 --api-address 0.0.0.0 --alternator-port 8000 --alternator-write-isolation forbid_rmw
    volumes:
      - scylla-data:/var/lib/scylla
    networks:
      - dreamhost-network
    healthcheck:
      test: ["CMD-SHELL", "nodetool status | grep -E '^UN' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  init-db:
    image: node:18-alpine
    container_name: dreamhost-init
    depends_on:
      scylladb:
        condition: service_healthy
    working_dir: /app
    volumes:
      - .:/app
    networks:
      - dreamhost-network
    environment:
      - NODE_ENV=test
      - SCYLLA_CONTACT_POINTS=scylladb:9042
      - SCYLLA_LOCAL_DATACENTER=datacenter1
      - SCYLLA_KEYSPACE=app_keyspace
      - DYNAMODB_ENDPOINT=http://scylladb:8000
    command: >
      sh -c "
        npm install --silent &&
        (node scripts/wait-and-init.js || true) &&
        node scripts/init-dynamo-tables.js &&
        echo 'Seeding token registry...' &&
        node modules/tokenRegistry/scripts/seed-admin-data.js &&
        echo 'Seeding payment gateway...' &&
        node modules/payment/scripts/seed-payment-gateway-data.js &&
        echo 'Seed completed.'
      "
    restart: "no"

  app:
    image: node:18-alpine
    container_name: dreamhost-app
    depends_on:
      init-db:
        condition: service_completed_successfully
    working_dir: /app
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    networks:
      - dreamhost-network
    environment:
      - NODE_ENV=production
      - PORT=3000
      - ADMIN_PORT=3000
      - DYNAMODB_ENDPOINT=http://scylladb:8000
      - SCYLLA_CONTACT_POINTS=scylladb
      - SCYLLA_LOCAL_DATACENTER=datacenter1
      - SCYLLA_KEYSPACE=app_keyspace
    command: node admin-server.js
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => { let d = ''; r.on('data', c => d += c); r.on('end', () => process.exit(r.statusCode === 200 ? 0 : 1)); }).on('error', () => process.exit(1));"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  test:
    image: node:18-alpine
    container_name: dreamhost-test
    depends_on:
      app:
        condition: service_healthy
    working_dir: /app
    volumes:
      - .:/app
    networks:
      - dreamhost-network
    environment:
      - NODE_ENV=test
      - DYNAMODB_ENDPOINT=http://scylladb:8000
      - ADMIN_API_URL=http://app:3000
    command: >
      sh -c "
        npm install --silent &&
        echo 'Running payment gateway tests (against ScyllaDB)...' &&
        npm run test:payment-gateway -- --ci &&
        echo 'Running admin API integration tests (against app:3000)...' &&
        npm run test:integration -- --ci &&
        echo 'All tests passed.'
      "
    restart: "no"

volumes:
  scylla-data:
    driver: local

networks:
  dreamhost-network:
    driver: bridge
